class ApplicationController < ActionController::API
    # locks down entire app to only authorized users
    before_action :authorized

    def encode_token(payload)
        JWT.encode(payload, ENV['SECRET_KEY'])
    end
    
    # gets the authorization header, which will look like { Authorization: 'Bearer <token>' }
    def auth_header
        request.headers['Authorization']
    end

    def decode_token
      if auth_header
        token = auth_header.split(' ')[1]
  
        begin
          JWT.decode(token, ENV['SECRET_KEY'], true, algorithm: 'HS256')
        rescue JWT::DecodeError
          nil
        end
      end
    end

    # finds the user associated with the decoded token
    def login_user
      if decode_token
        @caregiver_id = decode_token[0]['caregiver_id']
        @parent_id = decode_token[0]['parent_id']
        return @caregiver = Caregiver.find_by(id: @caregiver_id) if @caregiver_id
        return @parent = Parent.find_by(id: @parent_id) if @parent_id
      end
    end
    
    # returns a bool based on if we found the user
    def logged_in?
      !!login_user
    end
    
    # send back an error to log in unless user is logged in
    def authorized
        render json: { errors: 'Please log in' }, status: :unauthorized unless logged_in?
    end
end